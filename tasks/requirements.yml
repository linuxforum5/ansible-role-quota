---
- name: Requirements
  block:

    - name: Packages, directories and files present when quota
      block:

        - name: Packages present
          apt:
            pkg:
              - jc
              - quota
              - quotatool
            state: present
            autoclean: true
            autoremove: true

        - name: Ansible facts.d directory present
          ansible.builtin.file:
            path: /etc/ansible/facts.d
            state: directory
            recurse: true
            mode: 0700
            owner: root
            group: root

        - name: "Ansible local facts repquota script present for {{ quota_name }}"
          ansible.builtin.template:
            src: repquota.fact.j2
            dest: "/etc/ansible/facts.d/repquota_{{ quota_name }}.fact"
            mode: 0700
            owner: root
            group: root
          register: quota_repquota_facts

        - name: "Ansible local facts quotatool script present for {{ quota_name }}"
          ansible.builtin.template:
            src: quotatool.fact.j2
            dest: "/etc/ansible/facts.d/quotatool_{{ quota_name }}.fact"
            mode: 0700
            owner: root
            group: root
          register: quota_quotatool_facts

        - name: Re-read Ansible local facts
          ansible.builtin.setup:
            filter: ansible_local
          when: ( quota_repquota_facts.changed ) or ( quota_quotatool_facts.changed )

      when: quota

    - name: Packages, directories and files absent when not quota
      block:

        - name: Ansible local facts repquota script absent when not quota
          file:
            path: /etc/ansible/facts.d/repquota.fact
            state: absent

        - name: Packages absent
          apt:
            pkg:
              - quota
              - quotatool
            state: absent
            autoclean: true
            autoremove: true

        - name: Re-read Ansible facts
          ansible.builtin.setup:

      when: not quota

  tags:
    - quota
...
